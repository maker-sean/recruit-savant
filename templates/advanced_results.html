{% extends "base.html" %}

{% block content %}
<div class="results-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2>Advanced Analysis: Synthetic xwOBA</h2>
            <p style="color: #6b7280; margin-top: -10px;">Customizable Weighted Formula</p>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <a href="javascript:history.back()" class="btn secondary">&larr; Back to Results</a>
            <a href="/" class="btn secondary">Upload New File</a>
        </div>
    </div>

    <div class="analysis-grid">
        <!-- Explanation Section -->
        <div class="explanation-section card">
            <h3>Understanding Synthetic xwOBA</h3>

            <div class="infographic-container">
                <img src="{{ url_for('static', filename='what_is_xwoba.png') }}" alt="What is xwOBA?"
                    class="infographic">
            </div>

            <div class="text-content">
                <p><strong>Our Synthetic Model</strong> bridges the gap in high school data by using the strongest
                    available drivers of production:</p>
                <ul>
                    <li><strong>Power (Max EV):</strong> A strong proxy for damage on contact.</li>
                    <li><strong>Contact Ability (Contact%):</strong> The foundation of putting the ball in play.</li>
                    <li><strong>Plate Discipline (BB% & K%):</strong> The ability to control the zone.</li>
                </ul>
                <p style="font-size: 0.9em; color: #666;"><em>Note: "Power Score" and "Contact Score" are normalized
                        values (0-1 scale). Max EV is scaled (75mph=0, 110mph=1). Contact% is scaled (70%=0,
                        100%=1).</em></p>
            </div>

            <h3>The Formula</h3>
            <div class="infographic-container">
                <img src="{{ url_for('static', filename='formula_infographic.png') }}"
                    alt="Synthetic xwOBA Formula Infographic" class="infographic">
            </div>

            <div class="formula-text">
                <p>
                    <span class="math-term">Base Value</span>
                    + (<span class="math-term">BB%</span> × Weight)
                    - (<span class="math-term">K%</span> × Weight)
                    + (<span class="math-term">Max EV Score</span> × Weight)
                    + (<span class="math-term">Contact Score</span> × Weight)
                </p>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="config-section card">
            <h3>Adjust Formula Weights</h3>
            <p style="margin-bottom: 15px;">Customize the importance of each metric.</p>
            <form action="/advanced_analysis" method="post" class="weights-form">
                <div class="form-group">
                    <label for="base_woba">Base wOBA Value:</label>
                    <input type="number" step="0.001" name="base_woba" id="base_woba"
                        value="{{ weights['base_woba'] }}">
                </div>
                <div class="form-group">
                    <label for="w_bb">Walk Weight (BB%):</label>
                    <input type="number" step="0.01" name="w_bb" id="w_bb" value="{{ weights['w_bb'] }}">
                </div>
                <div class="form-group">
                    <label for="w_k">Strikeout Penalty (K%):</label>
                    <input type="number" step="0.01" name="w_k" id="w_k" value="{{ weights['w_k'] }}">
                </div>
                <div class="form-group">
                    <label for="w_power">Power Weight (Max EV):</label>
                    <input type="number" step="0.01" name="w_power" id="w_power" value="{{ weights['w_power'] }}">
                </div>
                <div class="form-group">
                    <label for="w_contact">Contact Weight (Contact%):</label>
                    <input type="number" step="0.01" name="w_contact" id="w_contact" value="{{ weights['w_contact'] }}">
                </div>
                <button type="submit" class="btn primary">Recalculate</button>
                <button type="button" class="btn secondary" onclick="resetDefaults()">Reset Defaults</button>
            </form>
        </div>
    </div>

    <!-- Table Section -->
    <div class="table-responsive card" style="margin-bottom: 30px;">
        <h3>Player Rankings</h3>
        <table>
            <thead>
                <tr>
                    <th class="sortable" data-sort="string">Player Name</th>
                    <th class="sortable desc" data-sort="number">Synthetic xwOBA</th>
                    <th class="sortable" data-sort="number">Max EV</th>
                    <th class="sortable" data-sort="number">Contact%</th>
                    <th class="sortable" data-sort="number">BB%</th>
                    <th class="sortable" data-sort="number">K%</th>
                </tr>
            </thead>
            <tbody>
                {% for player in players %}
                <tr>
                    <td class="player-name">{{ player['Player Name'] }}</td>
                    <td class="highlight-metric">{{ player['Synthetic xwOBA'] }}</td>

                    {# Max EV #}
                    {% if player['Max EV_pct'] != 'N/A' %}
                    {% set pct = player['Max EV_pct']|int %}
                    {% if pct >= 90 %}<td class="rank-90-100">{{ player['Max EV'] }}</td>
                    {% elif pct >= 60 %}<td class="rank-60-89">{{ player['Max EV'] }}</td>
                    {% elif pct >= 40 %}<td class="rank-40-59">{{ player['Max EV'] }}</td>
                    {% elif pct >= 11 %}<td class="rank-11-39">{{ player['Max EV'] }}</td>
                    {% else %}<td class="rank-1-10">{{ player['Max EV'] }}</td>
                    {% endif %}
                    {% else %}
                    <td>{{ player['Max EV'] }}</td>
                    {% endif %}

                    {# Contact% #}
                    {% if player['Contact%_pct'] != 'N/A' %}
                    {% set pct = player['Contact%_pct']|int %}
                    {% if pct >= 90 %}<td class="rank-90-100">{{ player['Contact%'] }}</td>
                    {% elif pct >= 60 %}<td class="rank-60-89">{{ player['Contact%'] }}</td>
                    {% elif pct >= 40 %}<td class="rank-40-59">{{ player['Contact%'] }}</td>
                    {% elif pct >= 11 %}<td class="rank-11-39">{{ player['Contact%'] }}</td>
                    {% else %}<td class="rank-1-10">{{ player['Contact%'] }}</td>
                    {% endif %}
                    {% else %}
                    <td>{{ player['Contact%'] }}</td>
                    {% endif %}

                    {# BB% #}
                    {% if player['BB%_pct'] != 'N/A' %}
                    {% set pct = player['BB%_pct']|int %}
                    {% if pct >= 90 %}<td class="rank-90-100">{{ player['BB%'] }}</td>
                    {% elif pct >= 60 %}<td class="rank-60-89">{{ player['BB%'] }}</td>
                    {% elif pct >= 40 %}<td class="rank-40-59">{{ player['BB%'] }}</td>
                    {% elif pct >= 11 %}<td class="rank-11-39">{{ player['BB%'] }}</td>
                    {% else %}<td class="rank-1-10">{{ player['BB%'] }}</td>
                    {% endif %}
                    {% else %}
                    <td>{{ player['BB%'] }}</td>
                    {% endif %}

                    {# K% #}
                    {% if player['K%_pct'] != 'N/A' %}
                    {% set pct = player['K%_pct']|int %}
                    {% if pct >= 90 %}<td class="rank-90-100">{{ player['K%'] }}</td>
                    {% elif pct >= 60 %}<td class="rank-60-89">{{ player['K%'] }}</td>
                    {% elif pct >= 40 %}<td class="rank-40-59">{{ player['K%'] }}</td>
                    {% elif pct >= 11 %}<td class="rank-11-39">{{ player['K%'] }}</td>
                    {% else %}<td class="rank-1-10">{{ player['K%'] }}</td>
                    {% endif %}
                    {% else %}
                    <td>{{ player['K%'] }}</td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function resetDefaults() {
        document.getElementById('base_woba').value = 0.280;
        document.getElementById('w_bb').value = 0.7;
        document.getElementById('w_k').value = 0.7;
        document.getElementById('w_power').value = 0.25;
        document.getElementById('w_contact').value = 0.2;
        document.querySelector('form').submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const table = document.querySelector('table');
        const headers = table.querySelectorAll('th');
        const tbody = table.querySelector('tbody');

        // Initial Sort: Synthetic xwOBA (Index 1) Descending
        sortTable(1, false);

        headers.forEach((header, index) => {
            header.style.cursor = 'pointer';
            header.title = "Click to sort";

            header.addEventListener('click', () => {
                const isAscending = header.classList.contains('asc');

                // Reset other headers
                headers.forEach(h => h.classList.remove('asc', 'desc'));

                // Toggle sort direction
                if (isAscending) {
                    header.classList.remove('asc');
                    header.classList.add('desc');
                    sortTable(index, false); // Descending
                } else {
                    header.classList.remove('desc');
                    header.classList.add('asc');
                    sortTable(index, true); // Ascending
                }
            });
        });

        function sortTable(columnIndex, ascending) {
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const direction = ascending ? 1 : -1;

            rows.sort((rowA, rowB) => {
                const cellA = rowA.children[columnIndex].innerText.trim();
                const cellB = rowB.children[columnIndex].innerText.trim();

                // Handle N/A
                if (cellA === 'N/A') return 1;
                if (cellB === 'N/A') return -1;

                // Try numeric sort
                const numA = parseFloat(cellA);
                const numB = parseFloat(cellB);

                if (!isNaN(numA) && !isNaN(numB)) {
                    return (numA - numB) * direction;
                } else {
                    // String sort for names
                    return cellA.localeCompare(cellB) * direction;
                }
            });

            // Re-append rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }
    });
</script>

<style>
    .results-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .analysis-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .infographic-container {
        text-align: center;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
    }

    .infographic {
        max-width: 400px;
        width: 100%;
        height: auto;
        border-radius: 4px;
    }

    .weights-form {
        display: grid;
        gap: 10px;
    }

    .form-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .form-group input {
        width: 80px;
        padding: 5px;
    }

    .math-term {
        font-weight: bold;
        color: #2c3e50;
        background: #ecf0f1;
        padding: 2px 5px;
        border-radius: 3px;
    }

    .highlight-metric {
        font-weight: bold;
        background-color: #e8f6f3;
        color: #16a085;
    }
</style>
{% endblock %}