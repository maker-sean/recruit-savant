{% extends "base.html" %}

{% block content %}
<div class="results-section">
    <h2>Percentile Rankings</h2>
    <a href="/" class="btn-new">Start Over</a>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Player Name</th>
                    {% for metric in metrics %}
                    <th>{{ metric }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for player in players %}
                <tr>
                    <td class="player-name">{{ player['Player Name'] }}</td>
                    {% for metric in metrics %}
                    {% set val = player[metric] %}
                    {% if val == 'N/A' %}
                    <td class="rank-na">N/A</td>
                    {% else %}
                    {# Determine color class #}
                    {% if val >= 90 %}
                    <td class="rank-90-100">{{ val|int }}</td>
                    {% elif val >= 60 %}
                    <td class="rank-60-89">{{ val|int }}</td>
                    {% elif val >= 40 %}
                    <td class="rank-40-59">{{ val|int }}</td>
                    {% elif val >= 11 %}
                    <td class="rank-11-39">{{ val|int }}</td>
                    {% else %}
                    <td class="rank-1-10">{{ val|int }}</td>
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const table = document.querySelector('table');
        const headers = table.querySelectorAll('th');
        const tbody = table.querySelector('tbody');

        headers.forEach((header, index) => {
            header.style.cursor = 'pointer';
            header.title = "Click to sort";

            header.addEventListener('click', () => {
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const isAscending = header.classList.contains('asc');

                // Reset other headers
                headers.forEach(h => h.classList.remove('asc', 'desc'));

                // Toggle sort direction
                if (isAscending) {
                    header.classList.remove('asc');
                    header.classList.add('desc');
                } else {
                    header.classList.remove('desc');
                    header.classList.add('asc');
                }

                const direction = isAscending ? -1 : 1;

                rows.sort((rowA, rowB) => {
                    const cellA = rowA.children[index].innerText.trim();
                    const cellB = rowB.children[index].innerText.trim();

                    // Handle N/A
                    if (cellA === 'N/A') return 1;
                    if (cellB === 'N/A') return -1;

                    // Try numeric sort
                    const numA = parseFloat(cellA);
                    const numB = parseFloat(cellB);

                    if (!isNaN(numA) && !isNaN(numB)) {
                        return (numA - numB) * direction;
                    } else {
                        // String sort for names
                        return cellA.localeCompare(cellB) * direction;
                    }
                });

                // Re-append rows
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            });
        });
    });
</script>
{% endblock %}